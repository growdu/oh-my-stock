# oh-my-stock

## 股票数据表设计

### 股票基础信息表 (stock_basic_info)

```sql
CREATE TABLE stock_basic_info (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL UNIQUE,        -- 股票代码(如:600000)
    name VARCHAR(50) NOT NULL,                -- 股票名称
    full_name VARCHAR(100),                   -- 公司全称
    industry VARCHAR(50),                     -- 所属行业
    area VARCHAR(50),                         -- 地区
    market VARCHAR(20),                       -- 市场类型(主板/创业板/科创板等)
    listing_date DATE,                        -- 上市日期
    outstanding_shares DECIMAL(20,4),         -- 流通股本(万股)
    total_shares DECIMAL(20,4),               -- 总股本(万股)
    is_hs BOOLEAN,                            -- 是否沪深港通标的
    status VARCHAR(20),                       -- 上市状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_stock_basic_symbol ON stock_basic_info(symbol);
CREATE INDEX idx_stock_basic_industry ON stock_basic_info(industry);
```

### 股票日线交易数据表 (stock_daily_data)

```sql
CREATE TABLE stock_daily_data (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,              -- 股票代码
    trade_date DATE NOT NULL,                 -- 交易日期
    open DECIMAL(12,4),                      -- 开盘价
    high DECIMAL(12,4),                      -- 最高价
    low DECIMAL(12,4),                       -- 最低价
    close DECIMAL(12,4),                     -- 收盘价
    adj_close DECIMAL(12,4),                 -- 后复权收盘价
    volume BIGINT,                           -- 成交量(股)
    turnover DECIMAL(20,4),                  -- 成交额(元)
    change_percent DECIMAL(10,4),            -- 涨跌幅(%)
    change_amount DECIMAL(10,4),             -- 涨跌额
    turnover_rate DECIMAL(10,4),             -- 换手率(%)
    pe_ttm DECIMAL(10,4),                    -- 市盈率(TTM)
    pb DECIMAL(10,4),                        -- 市净率
    amplitude DECIMAL(10,4),                 -- 振幅(%)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_stock_daily UNIQUE (symbol, trade_date)
);

CREATE INDEX idx_stock_daily_symbol ON stock_daily_data(symbol);
CREATE INDEX idx_stock_daily_date ON stock_daily_data(trade_date);
```

### 股票财务数据表 (stock_financial_data)

```sql
CREATE TABLE stock_financial_data (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,              -- 股票代码
    report_date DATE NOT NULL,                -- 报告期
    report_type VARCHAR(20),                  -- 报告类型(年报/季报等)
    eps DECIMAL(10,4),                       -- 每股收益
    eps_diluted DECIMAL(10,4),               -- 稀释每股收益
    total_revenue DECIMAL(20,4),             -- 营业总收入(元)
    operating_profit DECIMAL(20,4),          -- 营业利润(元)
    net_profit DECIMAL(20,4),                -- 净利润(元)
    total_assets DECIMAL(20,4),              -- 总资产(元)
    total_liabilities DECIMAL(20,4),         -- 总负债(元)
    equity DECIMAL(20,4),                    -- 股东权益(元)
    roe DECIMAL(10,4),                       -- 净资产收益率(%)
    gross_margin DECIMAL(10,4),              -- 毛利率(%)
    operating_cash_flow DECIMAL(20,4),       -- 经营活动现金流(元)
    investing_cash_flow DECIMAL(20,4),       -- 投资活动现金流(元)
    financing_cash_flow DECIMAL(20,4),       -- 筹资活动现金流(元)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_stock_financial UNIQUE (symbol, report_date, report_type)
);

CREATE INDEX idx_stock_financial_symbol ON stock_financial_data(symbol);
CREATE INDEX idx_stock_financial_date ON stock_financial_data(report_date);
```

### 股票指标数据表 (stock_indicators)

```sql
CREATE TABLE stock_indicators (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,              -- 股票代码
    calc_date DATE NOT NULL,                 -- 计算日期
    ma5 DECIMAL(12,4),                       -- 5日均线
    ma10 DECIMAL(12,4),                      -- 10日均线
    ma20 DECIMAL(12,4),                      -- 20日均线
    ma60 DECIMAL(12,4),                      -- 60日均线
    macd DECIMAL(12,4),                      -- MACD值
    dif DECIMAL(12,4),                       -- DIF值
    dea DECIMAL(12,4),                       -- DEA值
    k DECIMAL(12,4),                         -- KDJ-K值
    d DECIMAL(12,4),                         -- KDJ-D值
    j DECIMAL(12,4),                         -- KDJ-J值
    rsi6 DECIMAL(12,4),                      -- RSI6值
    rsi12 DECIMAL(12,4),                     -- RSI12值
    rsi24 DECIMAL(12,4),                     -- RSI24值
    boll_upper DECIMAL(12,4),                -- 布林线上轨
    boll_mid DECIMAL(12,4),                  -- 布林线中轨
    boll_lower DECIMAL(12,4),                -- 布林线下轨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_stock_indicators UNIQUE (symbol, calc_date)
);

CREATE INDEX idx_stock_indicators_symbol ON stock_indicators(symbol);
CREATE INDEX idx_stock_indicators_date ON stock_indicators(calc_date);
```

### 股票资金流向表 (stock_money_flow)

```sql
CREATE TABLE stock_money_flow (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,              -- 股票代码
    trade_date DATE NOT NULL,                 -- 交易日期
    main_net DECIMAL(20,4),                  -- 主力净流入(元)
    retail_net DECIMAL(20,4),                -- 散户净流入(元)
    large_order_ratio DECIMAL(10,4),         -- 大单成交占比(%)
    medium_order_ratio DECIMAL(10,4),        -- 中单成交占比(%)
    small_order_ratio DECIMAL(10,4),         -- 小单成交占比(%)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_stock_money_flow UNIQUE (symbol, trade_date)
);

CREATE INDEX idx_stock_money_flow_symbol ON stock_money_flow(symbol);
CREATE INDEX idx_stock_money_flow_date ON stock_money_flow(trade_date);
```

根据新的接口设计了包含科创板和创业板在内的资金流入表：

```sql
CREATE TABLE stock_money_flow_all (
    id SERIAL PRIMARY KEY,
    time_span INTEGER NOT NULL,
    serial_number INTEGER,
    symbol VARCHAR(10) NOT NULL,
    name VARCHAR(50),
    latest_price FLOAT,
    change_percent FLOAT,
    turnover_rate FLOAT,
    inflow_amount FLOAT,
    outflow_amount FLOAT,
    net_amount FLOAT,
    turnover FLOAT,
    trade_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uq_stock_money_flow_all UNIQUE (symbol, trade_date, time_span)
);
```

### 关系设计：

- 所有表通过symbol字段关联

- 使用复合唯一约束防止重复数据

### 数据类型选择：

- 价格类数据使用DECIMAL(12,4)保证精度

- 大额数据使用DECIMAL(20,4)避免溢出

- 日期字段统一使用DATE类型

### 索引优化：

- 为所有查询条件创建索引

- 主键使用自增序列

### 扩展性考虑：

- 预留created_at/updated_at字段

- 表结构支持多种数据频率(日/周/月)

### 与AKShare数据对应：

- 表字段设计与AKShare接口返回字段对应

- 保留原始数据的同时添加计算指标

### 数据插入规则

stock_basic_info使用get_basic_info.py获取并录入数据库。

#### stock_daily_data
stock_daily_data根据stock_basic_info里的字段使用akshare来获取数据，分成两部分：

- 有一个初始化标记，当其为true时，获取从当前日期开始往前数15个交易日的数据入库
- 每天下午四点，获取当天的数据入库，（非交易日不做任何操作）

同时为了防止访问频繁，已经入库过的股票数据可以直接跳过。（即先要过滤掉已经更新过的股票）

### stock_financial_data

stock_financial_data根据stock_basic_info里的字段使用akshare来获取数据.

### stock_money_flow

stock_money_flow根据stock_basic_info里的字段使用akshare来获取数据.

### target_stock

新建一张表target_trend_stock，用于存储筛选出来的股票数据,需要存储股票名称，股票代码，当前价格，三日内涨幅，筛选规则。

并且设计一套筛选框架，通过创建筛选规则，可以筛选出股票，比如限制板块，限制净流入，限制连涨天数，这些条件通过json文件来配置，每一条json对应一条筛选规则。

其库表结构如下：

```shell
CREATE TABLE target_trend_stock (
    id SERIAL PRIMARY KEY,
    symbol VARCHAR(10) NOT NULL,         -- 股票代码
    name TEXT NOT NULL,                  -- 股票名称
    current_price NUMERIC(10, 2) NOT NULL, -- 当前价格
    rise_3d NUMERIC(6, 2),               -- 三日内涨幅（%）
    rule_name TEXT,                      -- 触发的筛选规则名称
    rule_config JSONB,                   -- 筛选规则的原始配置(JSON)
    created_at TIMESTAMP DEFAULT NOW()   -- 入库时间
);
```

### 股票数据视图

在数据库中，定义一个 SQL 视图，把 stock_daily_data、stock_indicator、stock_money_flow_all 按照 (symbol, trade_date) 对齐。

```sql
SELECT f.name,
    d.symbol,
    d.trade_date,
    d.open,
    d.close,
    d.high,
    d.low,
    d.volume,
    d.turnover_rate,
    d.change_percent,
    f.inflow_amount,
    f.outflow_amount,
    f.net_amount,
    f.turnover
   FROM (stock_daily_data d
     JOIN stock_money_flow_all f ON ((((d.symbol)::text = (f.symbol)::text) AND (d.trade_date = f.trade_date))))
  ORDER BY d.change_percent DESC
```

物化视图（Materialized View）和普通视图不同，它会缓存查询结果，适合你这种经常查、但不需要实时更新的历史数据。

```sql
-- 删除旧的（如果有）
DROP MATERIALIZED VIEW IF EXISTS stock_history_mv;

-- 创建物化视图
SELECT f.name,
    d.symbol,
    d.trade_date,
    d.open,
    d.close,
    d.high,
    d.low,
    d.volume,
    d.turnover_rate,
    d.change_percent,
    f.inflow_amount,
    f.outflow_amount,
    f.net_amount,
    f.turnover
   FROM (stock_daily_data d
     JOIN stock_money_flow_all f ON ((((d.symbol)::text = (f.symbol)::text) AND (d.trade_date = f.trade_date))))
  ORDER BY d.change_percent DESC

-- 为查询加速建索引
CREATE INDEX idx_stock_history_mv_symbol_date
ON stock_history_mv(symbol, trade_date DESC);

```

物化视图不会自动更新，需要手动或定时刷新：

```shell
REFRESH MATERIALIZED VIEW stock_history_mv;
```

如果数据量很大，可以用 CONCURRENTLY 来避免锁表：

```shell
REFRESH MATERIALIZED VIEW CONCURRENTLY stock_history_mv;
```

## 用户表

- 用户表（User）：存放用户基本信息，考虑到安全性，需要加密或脱敏字段（比如密码哈希、手机号/邮箱加密）。

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 使用UUID更安全
    username VARCHAR(50) NOT NULL UNIQUE,          -- 用户名，唯一
    password_hash TEXT NOT NULL,                   -- 密码哈希（bcrypt/argon2）
    email VARCHAR(100) UNIQUE,                     -- 邮箱（可选，加密后存）
    phone VARCHAR(20) UNIQUE,                      -- 手机号（可选，加密后存）
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), -- 注册时间（含时区）
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), -- 更新时间
    is_active BOOLEAN NOT NULL DEFAULT TRUE,       -- 是否启用

    CONSTRAINT chk_username CHECK (char_length(username) >= 3)
);

-- 自动更新时间
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_users_updated
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

```

- 用户收藏股票表（UserFavoriteStocks）：存放用户收藏的股票列表。

```sql
CREATE TABLE user_favorite_stocks (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL,
    symbol VARCHAR(20) NOT NULL,                   -- 股票代码
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(), -- 收藏时间

    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT uniq_user_stock UNIQUE (user_id, symbol)
);

-- 加快查询
CREATE INDEX idx_user_favorite_symbol ON user_favorite_stocks(symbol);
CREATE INDEX idx_user_favorite_user ON user_favorite_stocks(user_id);


```

- 用户选股规则表（UserStockRules）：存放用户定义的选股条件/策略。

```sql
CREATE TABLE user_stock_rules (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL,
    rule_name VARCHAR(100) NOT NULL,
    rule_expression JSONB NOT NULL,                 -- 使用 JSONB 存储规则
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    CONSTRAINT fk_rule_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- JSONB 索引（便于查询规则条件）
CREATE INDEX idx_rule_expr_gin ON user_stock_rules USING gin (rule_expression);

-- 自动更新时间
CREATE TRIGGER trg_rules_updated
BEFORE UPDATE ON user_stock_rules
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

```

### 添加规则

1.

```json
{
  "user_id": "f0dead9c-0dcd-4b8d-b697-136f512e83dd",
  "rule_name": "低PE大盘涨幅股",
  "rule_expression": {
    "pe_ratio": {"lt": 20},
    "market_cap": {"gt": 1000000000},
    "change_percent": {"gt": 5}
  }
}

```

2. 

```json
{
  "user_id": "f0dead9c-0dcd-4b8d-b697-136f512e83dd",
  "rule_name": "高换手率强势股",
  "rule_expression": {
    "turnover_rate": {"gt": 10},
    "change_percent": {"gt": 3},
    "volume": {"gt": 1000000}
  }
}

```

3.

```json
{
  "user_id": "f0dead9c-0dcd-4b8d-b697-136f512e83dd",
  "rule_name": "Boll突破买入",
  "rule_expression": {
    "close": {"gt": "boll_upper"},
    "ma20": {"gt": "ma60"},
    "rsi6": {"lt": 70}
  }
}

```